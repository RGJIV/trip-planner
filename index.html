<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Route Calculator</title>
</head>
<body>
    <h1>Custom Route Calculator</h1>
    <p>Enter origin, destination, and optional stops. This tool uses GraphHopper API with a custom model to prefer longer uninterrupted high-speed roads and penalize smaller roads with more turns and stops.</p>
    
    <form id="routeForm">
        <label for="apiKey">GraphHopper API Key:</label>
        <input type="text" id="apiKey" required placeholder="Enter your API key"><br><br>
        
        <label for="origin">Origin:</label>
        <input type="text" id="origin" required value="55 Chestnut Sq, Cashiers, NC 28717"><br><br>
        
        <label for="destination">Destination:</label>
        <input type="text" id="destination" required value="139 Laurens St NW, Aiken, SC 29801"><br><br>
        
        <div id="stopsContainer">
            <label>Stops (optional):</label><br>
            <input type="text" class="stop" placeholder="Add a stop"><br>
        </div>
        <button type="button" onclick="addStop()">Add Another Stop</button><br><br>
        
        <button type="button" onclick="calculateRoute()">Calculate Route and Generate Link</button>
    </form>
    
    <div id="result"></div>
    
    <script>
        function addStop() {
            const container = document.getElementById('stopsContainer');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'stop';
            input.placeholder = 'Add a stop';
            container.appendChild(input);
            container.appendChild(document.createElement('br'));
        }

        async function calculateRoute() {
            const apiKey = document.getElementById('apiKey').value;
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            const stops = Array.from(document.getElementsByClassName('stop'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            const points = [origin, ...stops, destination];

            const customModel = {
                "speed": [
                    {
                        "if": "road_class == MOTORWAY",
                        "limit_to": "130"
                    }
                ],
                "priority": [
                    {
                        "if": "road_class == RESIDENTIAL",
                        "multiply_by": "0.1"
                    }
                ],
                "distance_influence": 200
            };

            const requestBody = {
                "points": points,
                "custom_model": customModel,
                "ch.disable": true,
                "profile": "car"
            };

            try {
                const response = await fetch(`https://graphhopper.com/api/1/route?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const path = data.paths[0];

                // Extract waypoints from instructions (turn points)
                const instructions = path.instructions;
                const coords = path.points.coordinates; // [lon, lat] array

                const waypoints = instructions
                    .filter(inst => inst.distance > 0) // Filter meaningful turns
                    .map(inst => {
                        const pointIndex = inst.interval[0]; // Start of interval
                        const coord = coords[pointIndex];
                        return `${coord[1]},${coord[0]}`; // lat,lon for Google
                    });

                // Remove duplicates if any
                const uniqueWaypoints = [...new Set(waypoints)];

                // Limit to 9 waypoints max for Google Maps
                const selectedWaypoints = uniqueWaypoints.slice(0, 9);

                // Generate Google Maps URL
                const originEnc = encodeURIComponent(origin);
                const destEnc = encodeURIComponent(destination);
                const waypointsEnc = selectedWaypoints.map(wp => encodeURIComponent(wp)).join('|');
                
                const googleUrl = `https://www.google.com/maps/dir/?api=1&origin=${originEnc}&destination=${destEnc}&waypoints=${waypointsEnc}&travelmode=driving`;

                document.getElementById('result').innerHTML = `
                    <p>Custom Route Calculated!</p>
                    <p>Google Maps Link: <a href="${googleUrl}" target="_blank">${googleUrl}</a></p>
                `;
            } catch (error) {
                document.getElementById('result').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>